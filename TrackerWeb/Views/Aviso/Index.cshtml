@model TrackerWeb.Models.AvisoViewModel
@{
    ViewData["Title"] = "Avisos";
}

<h1>Avisos</h1>

<div class="alert alert-success" id="success-addAviso" style="display:none">
   
</div>

<div class="col-mb-3">
    <div class="form-check form-switch col-sm-4 float-start">
        <input class="form-check-input" type="checkbox" id="flexSwitchSoloCerrados">
        <label class="form-check-label" for="flexSwitchCheckDefault">Incluir avisos cerrarados</label>
    </div>
    <div class="col-sm-4 float-end">
        <button type="button" class="btn btn-light float-end" id="btnAddNuevoAviso">Nuevo Aviso</button>
    </div>
</div>

<br />
<br />
<br />
<br />

<div id="gridAvisos" class="col-md-12"> </div>

<div class="modal fade" id="newAvisoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Nuevo Aviso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body align-items-center">
                @Html.Partial("_AddAviso",Model)
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnSaveNewAviso" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>


<script>

    var model = @Html.Raw(Json.Serialize(@Model));
    var datosGrid = model.avisos.filter(x => !x.desestado.startsWith("Cerrada"));

    var grid = $("#gridAvisos").dxDataGrid({
        dataSource: {
            key: "idcaso",
            load: function () {
                return datosGrid;
            }
        },
        allowColumnResizing: true,
        columnAutoWidth: true,
        searchPanel: { visible: true },
        headerFilter: { visible: true },
        filterRow: { visible: true },
        filterPanel: { visible: true },
        paging: {
            pageSize: 10,
        },
        pager: {
            visible: true,
            allowedPageSizes: [5, 10, 20, 100, 500],
            showPageSizeSelector: true,
            showInfo: true,
            showNavigationButtons: true,
        },
        selection: {
            mode: 'multiple'
        },
        export: {
            enabled: true
        },
        onExporting: function (e) {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Main sheet');

            DevExpress.excelExporter.exportDataGrid({
                worksheet: worksheet,
                component: e.component
            }).then(function () {
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'Avisos.xlsx');
                });
            });
            e.cancel = true;
        },
        columns: [
            "fecha",
            { dataField: "cliente", width: 200, format: "fixedPoint" },
            "desestado",
            "destipo",
            "desorigen",
            "prioridad",
            "numcaso",
            "desfuente",
            { dataField: "descripcion", width: 200 },
            "asignado",
            "empleado"
        ], onRowDblClick(e) {
            EditCaso(e.data.idcaso);
        }
    });

    $("#flexSwitchSoloCerrados").change(() => {
        datosGrid = model.avisos.filter(x => !x.desestado.startsWith("Cerrada"));
        if ($("#flexSwitchSoloCerrados").prop("checked")) {
            datosGrid = model.avisos;
        }
        grid.dxDataGrid("getDataSource").reload();
    });

    $("#btnSaveNewAviso").click(() => {
        var NuevoAviso = {
            IDCLIENTE: selectCliente[0].selectize.getValue(),
            FUENTE: selectFuente[0].selectize.getValue(),
            ESTADO: selectEstado[0].selectize.getValue(),
            TIPO: selectTipo[0].selectize.getValue(),
            ORIGEN: selectOrigen[0].selectize.getValue(),
            FECHA: dateTimeBox.dxDateBox("instance").option('value').toLocaleTimeString("es-ES"),
            PRIORIDAD: $("input[name=prioridad]:checked").val(),
            DESCRIPCION: $("#textDescripcion").val(),
            IDCASO:""
        }

        var url = "@Url.Action("Create","Aviso")";
        if ($("#IdNumCaso").val() != ""){
            url = "@Url.Action("Edit","Aviso")";
            NuevoAviso.IDCASO = $("#IdNumCaso").val();
        }

        //Hacer insert en BBDD y modelo
        $.ajax({
            type: "POST",
            url: url,
            data: NuevoAviso,
            dataType: "json",
            success: function (response) {
                if (response != null) {
                    //alert("Name : " + response.Name + ", Designation : " + response.Designation + ", Location :" + response.Location);
                    model = response;
                    //Recargar grid
                    datosGrid = model.avisos.filter(x => !x.desestado.startsWith("Cerrada"))
                    grid.dxDataGrid("getDataSource").reload();
                    $('#newAvisoModal').modal('toggle');
                    $('#success-addAviso').show();
                    $("#success-addAviso").fadeTo(2000, 500).slideUp(500, function () {
                        $("#success-addAviso").slideUp(500);
                    });
                } else {
                    alert("Something went wrong");
                }
            },
            failure: function (response) {
                alert(response.responseText);
            },
            error: function (response) {
                alert(response.responseText);
            }
        });

    });

    $('#btnAddNuevoAviso').click(() =>{
        //Vaciar todo
        $("#IdNumCaso").val("");
        selectCliente[0].selectize.clear();
        selectFuente[0].selectize.clear();
        selectEstado[0].selectize.clear();
        selectTipo[0].selectize.clear();
        selectOrigen[0].selectize.clear();
        model.HistorialAviso = [];
        gridHistorial.dxDataGrid("getDataSource").reload();
        $("#textDescripcion").val("");
        $("#prioridadRadio2").prop("checked", true);
        $('#success-addAviso').text("!Aviso creado correctamente!");

        $('#newAvisoModal').modal('show');
    });

</script>
